# ══════════════════════════════════════════════════════════════════════════════
# Project Apex - Development Container
# Full-featured development environment with all required tools
# ══════════════════════════════════════════════════════════════════════════════

# syntax=docker/dockerfile:1.7

FROM mcr.microsoft.com/devcontainers/base:bookworm

# Labels
LABEL org.opencontainers.image.title="Apex Development Container" \
      org.opencontainers.image.description="Full development environment for Project Apex" \
      org.opencontainers.image.version="0.1.0" \
      org.opencontainers.image.authors="Aezi <aezi.zhu@icloud.com>" \
      org.opencontainers.image.source="https://github.com/apex-swarm/apex"

# Avoid prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# ─────────────────────────────────────────────────────────────────────────────
# System Dependencies
# ─────────────────────────────────────────────────────────────────────────────
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Build essentials
    build-essential \
    pkg-config \
    cmake \
    # Version control
    git \
    git-lfs \
    # Network tools
    curl \
    wget \
    httpie \
    # Database clients
    postgresql-client \
    redis-tools \
    # Development utilities
    vim \
    neovim \
    tmux \
    htop \
    tree \
    jq \
    yq \
    ripgrep \
    fd-find \
    bat \
    fzf \
    # Protobuf
    protobuf-compiler \
    libprotobuf-dev \
    # SSL and crypto
    libssl-dev \
    ca-certificates \
    # Python build deps
    libffi-dev \
    libpq-dev \
    # Process management
    tini \
    # Shell
    zsh \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# ─────────────────────────────────────────────────────────────────────────────
# Rust Installation
# ─────────────────────────────────────────────────────────────────────────────
ENV RUSTUP_HOME=/usr/local/rustup \
    CARGO_HOME=/usr/local/cargo \
    PATH=/usr/local/cargo/bin:$PATH \
    RUST_VERSION=1.75.0

RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | \
    sh -s -- -y --default-toolchain ${RUST_VERSION} --profile default \
    && rustup component add \
        clippy \
        rustfmt \
        rust-analyzer \
    && chmod -R a+w ${RUSTUP_HOME} ${CARGO_HOME}

# Install Rust development tools
RUN cargo install --locked \
    cargo-watch \
    cargo-edit \
    cargo-audit \
    cargo-outdated \
    cargo-chef \
    sqlx-cli \
    && rm -rf /usr/local/cargo/registry/cache

# ─────────────────────────────────────────────────────────────────────────────
# Node.js Installation
# ─────────────────────────────────────────────────────────────────────────────
ENV NODE_VERSION=20
ENV NVM_DIR=/usr/local/nvm
ENV PATH=$NVM_DIR/versions/node/v${NODE_VERSION}/bin:$PATH

RUN mkdir -p $NVM_DIR \
    && curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash \
    && . $NVM_DIR/nvm.sh \
    && nvm install ${NODE_VERSION} \
    && nvm alias default ${NODE_VERSION} \
    && nvm use default \
    && npm install -g \
        pnpm \
        yarn \
        typescript \
        ts-node \
        eslint \
        prettier \
        @biomejs/biome

# ─────────────────────────────────────────────────────────────────────────────
# Python Installation
# ─────────────────────────────────────────────────────────────────────────────
ENV PYTHON_VERSION=3.11
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

# Install Python via pyenv for version management
ENV PYENV_ROOT=/usr/local/pyenv
ENV PATH=$PYENV_ROOT/shims:$PYENV_ROOT/bin:$PATH

RUN curl https://pyenv.run | bash \
    && pyenv install ${PYTHON_VERSION} \
    && pyenv global ${PYTHON_VERSION}

# Install UV for fast Python package management
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Install Python development tools
RUN pip install --upgrade pip \
    && pip install \
        pipx \
        poetry \
        hatch \
        ruff \
        black \
        mypy \
        pytest \
        pytest-cov \
        ipython \
        httpx \
        pre-commit

# ─────────────────────────────────────────────────────────────────────────────
# Docker-in-Docker Support
# ─────────────────────────────────────────────────────────────────────────────
RUN curl -fsSL https://get.docker.com | sh

# Install Docker Compose
RUN curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" \
    -o /usr/local/bin/docker-compose \
    && chmod +x /usr/local/bin/docker-compose

# ─────────────────────────────────────────────────────────────────────────────
# Additional Development Tools
# ─────────────────────────────────────────────────────────────────────────────

# Install GitHub CLI
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | \
    dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
    && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | \
    tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && apt-get update \
    && apt-get install -y gh \
    && rm -rf /var/lib/apt/lists/*

# Install k9s and kubectl for Kubernetes development
RUN curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/$(dpkg --print-architecture)/kubectl" \
    && install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl \
    && rm kubectl

RUN curl -sS https://webi.sh/k9s | sh

# Install Terraform
RUN curl -fsSL https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg \
    && echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | \
    tee /etc/apt/sources.list.d/hashicorp.list \
    && apt-get update \
    && apt-get install -y terraform \
    && rm -rf /var/lib/apt/lists/*

# ─────────────────────────────────────────────────────────────────────────────
# Shell Configuration
# ─────────────────────────────────────────────────────────────────────────────

# Install Oh My Zsh for better shell experience
RUN sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended

# Install Starship prompt
RUN curl -sS https://starship.rs/install.sh | sh -s -- -y

# ─────────────────────────────────────────────────────────────────────────────
# User Setup
# ─────────────────────────────────────────────────────────────────────────────

# Create apex user with proper permissions
ARG USERNAME=apex
ARG USER_UID=1000
ARG USER_GID=$USER_UID

RUN groupadd --gid $USER_GID $USERNAME || true \
    && useradd --uid $USER_UID --gid $USER_GID -m $USERNAME -s /bin/zsh || true \
    && echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/$USERNAME \
    && chmod 0440 /etc/sudoers.d/$USERNAME

# Set up user directories
RUN mkdir -p /home/$USERNAME/.config /home/$USERNAME/.local/share \
    && chown -R $USERNAME:$USERNAME /home/$USERNAME

# Copy shell configuration
COPY --chown=$USERNAME:$USERNAME docker/scripts/shell-init.sh /home/$USERNAME/.shell-init.sh

# Add shell initialization to zshrc
RUN echo 'source ~/.shell-init.sh' >> /home/$USERNAME/.zshrc \
    && echo 'eval "$(starship init zsh)"' >> /home/$USERNAME/.zshrc

# ─────────────────────────────────────────────────────────────────────────────
# Workspace Setup
# ─────────────────────────────────────────────────────────────────────────────
WORKDIR /workspace

# Set proper permissions for workspace
RUN chown -R $USERNAME:$USERNAME /workspace

# Add Docker group for Docker-in-Docker
RUN usermod -aG docker $USERNAME || true

# Switch to non-root user
USER $USERNAME

# Set default environment variables
ENV SHELL=/bin/zsh \
    EDITOR=vim \
    TERM=xterm-256color \
    COLORTERM=truecolor

# Health check
HEALTHCHECK --interval=60s --timeout=10s --start-period=30s --retries=3 \
    CMD echo "Dev container healthy" || exit 1

# Use tini as init
ENTRYPOINT ["/usr/bin/tini", "--"]

# Keep container running
CMD ["sleep", "infinity"]
