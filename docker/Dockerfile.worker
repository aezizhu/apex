# ══════════════════════════════════════════════════════════════════════════════
# Apex Agent Worker - Optimized Multi-Stage Dockerfile
# ══════════════════════════════════════════════════════════════════════════════
#
# Build stages:
#   1. builder - Install dependencies with UV for speed
#   2. runtime - Minimal production image
#
# Features:
#   - Multi-stage build for minimal image size
#   - UV package manager for fast dependency installation
#   - Non-root user for security
#   - Tini for proper signal handling
#   - Health checks
#
# Usage:
#   docker build -f docker/Dockerfile.worker -t apex-worker ./src/backend/agents
#   docker run -e APEX_LLM_OPENAI_API_KEY=sk-... apex-worker
#
# ══════════════════════════════════════════════════════════════════════════════

# syntax=docker/dockerfile:1.7

# ─────────────────────────────────────────────────────────────────────────────
# Stage 1: Builder - Install dependencies with UV
# ─────────────────────────────────────────────────────────────────────────────
FROM python:3.11-slim-bookworm AS builder

# Build-time environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    UV_COMPILE_BYTECODE=1 \
    UV_LINK_MODE=copy

# Install UV for fast dependency management
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /build

# Copy dependency files first for better caching
COPY pyproject.toml ./

# Create virtual environment and install dependencies
RUN --mount=type=cache,target=/root/.cache/uv \
    uv venv /opt/venv && \
    . /opt/venv/bin/activate && \
    uv pip install \
        httpx>=0.26.0 \
        pydantic>=2.5.0 \
        pydantic-settings>=2.0.0 \
        openai>=1.6.0 \
        anthropic>=0.8.0 \
        redis>=5.0.0 \
        opentelemetry-api>=1.22.0 \
        opentelemetry-sdk>=1.22.0 \
        opentelemetry-exporter-otlp>=1.22.0 \
        opentelemetry-instrumentation-httpx>=0.43b0 \
        structlog>=23.3.0 \
        tenacity>=8.2.0 \
        tiktoken>=0.5.0

# Copy source code and build the package
COPY apex_agents/ ./apex_agents/
COPY main.py ./

RUN --mount=type=cache,target=/root/.cache/uv \
    . /opt/venv/bin/activate && \
    uv pip install .

# ─────────────────────────────────────────────────────────────────────────────
# Stage 2: Runtime - Minimal production image
# ─────────────────────────────────────────────────────────────────────────────
FROM python:3.11-slim-bookworm AS runtime

# Labels
LABEL org.opencontainers.image.title="Apex Agent Worker" \
      org.opencontainers.image.description="Python agent worker for Project Apex" \
      org.opencontainers.image.version="0.1.0" \
      org.opencontainers.image.authors="Aezi <aezi.zhu@icloud.com>" \
      org.opencontainers.image.source="https://github.com/apex-swarm/apex"

# Runtime environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONFAULTHANDLER=1 \
    PYTHONPATH=/app \
    PATH="/opt/venv/bin:$PATH" \
    # Apex configuration defaults
    APEX_ENVIRONMENT=production \
    APEX_LOG_JSON=true \
    APEX_LOG_LEVEL=INFO \
    APEX_WORKER_NUM_AGENTS=5 \
    APEX_WORKER_POLL_INTERVAL_SECONDS=1.0 \
    APEX_WORKER_HEARTBEAT_INTERVAL_SECONDS=10.0 \
    APEX_BACKEND_HOST=apex-api \
    APEX_BACKEND_HTTP_PORT=8080 \
    APEX_REDIS_URL=redis://redis:6379

# Install minimal runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    tini \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Create non-root user for security
RUN groupadd --gid 1000 apex \
    && useradd --uid 1000 --gid apex --shell /sbin/nologin --create-home apex

WORKDIR /app

# Copy virtual environment from builder
COPY --from=builder --chown=apex:apex /opt/venv /opt/venv

# Copy application code
COPY --from=builder --chown=apex:apex /build/apex_agents/ ./apex_agents/
COPY --from=builder --chown=apex:apex /build/main.py ./

# Create directories for runtime data
RUN mkdir -p /app/data /app/logs \
    && chown -R apex:apex /app

# Switch to non-root user
USER apex

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8081/health || exit 1

# Expose metrics port
EXPOSE 8081

# Use tini as init system for proper signal handling
ENTRYPOINT ["/usr/bin/tini", "--"]

# Default command
CMD ["python", "main.py", "--workers", "1"]
