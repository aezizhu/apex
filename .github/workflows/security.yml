# ══════════════════════════════════════════════════════════════════════════════
# Project Apex - Security Scanning Pipeline
# ══════════════════════════════════════════════════════════════════════════════
# Runs security scans on code, dependencies, and container images
# Includes: cargo audit, pip audit, npm audit, Trivy, CodeQL, and more

name: Security

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

env:
  TRIVY_VERSION: '0.50.0'

jobs:
  # ════════════════════════════════════════════════════════════════════════════
  # Rust Security
  # ════════════════════════════════════════════════════════════════════════════
  rust-audit:
    name: Rust Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked

      - name: Run cargo audit
        working-directory: src/backend/core
        run: |
          cargo audit --json > audit-report.json || true
          cargo audit

      - name: Run cargo deny (licenses & advisories)
        working-directory: src/backend/core
        continue-on-error: true
        run: |
          # Create deny.toml if it doesn't exist
          if [ ! -f deny.toml ]; then
            cat > deny.toml << 'EOF'
          [advisories]
          vulnerability = "deny"
          unmaintained = "warn"
          yanked = "deny"
          notice = "warn"

          [licenses]
          unlicensed = "deny"
          allow = [
            "MIT",
            "Apache-2.0",
            "Apache-2.0 WITH LLVM-exception",
            "BSD-2-Clause",
            "BSD-3-Clause",
            "ISC",
            "Zlib",
            "0BSD",
            "Unicode-DFS-2016",
            "MPL-2.0",
          ]
          confidence-threshold = 0.8

          [bans]
          multiple-versions = "warn"
          wildcards = "allow"
          highlight = "all"

          [sources]
          unknown-registry = "deny"
          unknown-git = "warn"
          EOF
          fi

          cargo deny check

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rust-audit-report
          path: src/backend/core/audit-report.json

      - name: Check for critical vulnerabilities
        working-directory: src/backend/core
        run: |
          CRITICAL=$(cargo audit --json 2>/dev/null | jq '.vulnerabilities.count // 0')
          if [ "$CRITICAL" -gt 0 ]; then
            echo "::warning::Found $CRITICAL vulnerabilities in Rust dependencies"
          fi

  # ════════════════════════════════════════════════════════════════════════════
  # Python Security
  # ════════════════════════════════════════════════════════════════════════════
  python-audit:
    name: Python Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install audit tools
        run: |
          pip install pip-audit safety bandit[toml]

      - name: Install dependencies
        working-directory: src/backend/agents
        run: pip install -e ".[dev]"

      - name: Run pip-audit
        working-directory: src/backend/agents
        continue-on-error: true
        run: |
          pip-audit --format json --output pip-audit-report.json || true
          pip-audit

      - name: Run safety check
        working-directory: src/backend/agents
        continue-on-error: true
        run: |
          safety check --output json > safety-report.json 2>/dev/null || true
          safety check || true

      - name: Run bandit (SAST)
        working-directory: src/backend/agents
        continue-on-error: true
        run: |
          bandit -r apex_agents -f json -o bandit-report.json || true
          bandit -r apex_agents -ll

      - name: Upload audit reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-audit-reports
          path: |
            src/backend/agents/pip-audit-report.json
            src/backend/agents/safety-report.json
            src/backend/agents/bandit-report.json

  # ════════════════════════════════════════════════════════════════════════════
  # Node.js Security
  # ════════════════════════════════════════════════════════════════════════════
  npm-audit:
    name: npm Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: src/frontend
        run: npm ci

      - name: Run npm audit
        working-directory: src/frontend
        continue-on-error: true
        run: |
          npm audit --json > npm-audit-report.json 2>/dev/null || true
          npm audit --audit-level=moderate || true

      - name: Check for high/critical vulnerabilities
        working-directory: src/frontend
        run: |
          CRITICAL=$(npm audit --json 2>/dev/null | jq '.metadata.vulnerabilities.critical // 0')
          HIGH=$(npm audit --json 2>/dev/null | jq '.metadata.vulnerabilities.high // 0')

          if [ "$CRITICAL" -gt 0 ]; then
            echo "::error::Found $CRITICAL critical npm vulnerabilities"
          fi
          if [ "$HIGH" -gt 0 ]; then
            echo "::warning::Found $HIGH high severity npm vulnerabilities"
          fi

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-report
          path: src/frontend/npm-audit-report.json

  # ════════════════════════════════════════════════════════════════════════════
  # Secret Scanning
  # ════════════════════════════════════════════════════════════════════════════
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  # ════════════════════════════════════════════════════════════════════════════
  # Container Security
  # ════════════════════════════════════════════════════════════════════════════
  container-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - image: api
            dockerfile: infra/docker/Dockerfile.api
            context: .
          - image: worker
            dockerfile: src/backend/agents/Dockerfile
            context: src/backend/agents
          - image: dashboard
            dockerfile: src/frontend/Dockerfile
            context: src/frontend
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image for scanning
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: false
          load: true
          tags: apex/${{ matrix.image }}:scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'apex/${{ matrix.image }}:scan'
          format: 'sarif'
          output: 'trivy-${{ matrix.image }}.sarif'
          severity: 'CRITICAL,HIGH'
          vuln-type: 'os,library'
          ignore-unfixed: true

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-${{ matrix.image }}.sarif'
          category: 'trivy-${{ matrix.image }}'

      - name: Run Trivy (table output)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'apex/${{ matrix.image }}:scan'
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'
          vuln-type: 'os,library'
          ignore-unfixed: true

      - name: Run Dockle linter
        uses: erzz/dockle-action@v1
        with:
          image: 'apex/${{ matrix.image }}:scan'
          failure-threshold: high
          exit-code: 1
          exit-level: warn

  # ════════════════════════════════════════════════════════════════════════════
  # CodeQL Analysis
  # ════════════════════════════════════════════════════════════════════════════
  codeql-rust:
    name: CodeQL (Rust)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: 'c-cpp'  # CodeQL uses C++ for Rust analysis
          queries: security-extended

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install protobuf compiler
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Build
        working-directory: src/backend/core
        run: cargo build --release

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:rust"

  codeql-python:
    name: CodeQL (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: 'python'
          queries: security-extended
          source-root: src/backend/agents

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"

  codeql-javascript:
    name: CodeQL (JavaScript/TypeScript)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: 'javascript-typescript'
          queries: security-extended
          source-root: src/frontend

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"

  # ════════════════════════════════════════════════════════════════════════════
  # Infrastructure Security
  # ════════════════════════════════════════════════════════════════════════════
  infra-scan:
    name: Infrastructure Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Checkov (IaC scanner)
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: infra/
          framework: kubernetes,dockerfile,helm
          soft_fail: true
          output_format: sarif
          output_file_path: checkov-results.sarif

      - name: Upload Checkov results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-results.sarif
          category: 'checkov'

      - name: Run Kubesec
        run: |
          # Install kubesec
          curl -sSL https://github.com/controlplaneio/kubesec/releases/download/v2.14.0/kubesec_linux_amd64.tar.gz | tar xz
          chmod +x kubesec

          # Scan Kubernetes manifests
          for file in $(find infra/k8s -name "*.yaml" -o -name "*.yml"); do
            echo "Scanning $file..."
            ./kubesec scan "$file" || true
          done

      - name: Run Kube-linter
        uses: stackrox/kube-linter-action@v1
        with:
          directory: infra/k8s/helm
          format: sarif
          output-file: kube-linter.sarif

      - name: Upload Kube-linter results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: kube-linter.sarif
          category: 'kube-linter'

  # ════════════════════════════════════════════════════════════════════════════
  # Dependency Review (PRs only)
  # ════════════════════════════════════════════════════════════════════════════
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, MPL-2.0

  # ════════════════════════════════════════════════════════════════════════════
  # SBOM Generation
  # ════════════════════════════════════════════════════════════════════════════
  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate SBOM for Rust
        uses: anchore/sbom-action@v0
        with:
          path: src/backend/core
          artifact-name: sbom-rust.spdx.json
          output-file: sbom-rust.spdx.json
          format: spdx-json

      - name: Generate SBOM for Python
        uses: anchore/sbom-action@v0
        with:
          path: src/backend/agents
          artifact-name: sbom-python.spdx.json
          output-file: sbom-python.spdx.json
          format: spdx-json

      - name: Generate SBOM for Frontend
        uses: anchore/sbom-action@v0
        with:
          path: src/frontend
          artifact-name: sbom-frontend.spdx.json
          output-file: sbom-frontend.spdx.json
          format: spdx-json

      - name: Upload SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: sbom-reports
          path: sbom-*.spdx.json

  # ════════════════════════════════════════════════════════════════════════════
  # Security Report Summary
  # ════════════════════════════════════════════════════════════════════════════
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs:
      - rust-audit
      - python-audit
      - npm-audit
      - secret-scan
      - container-scan
      - codeql-rust
      - codeql-python
      - codeql-javascript
      - infra-scan
      - sbom
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports
        continue-on-error: true

      - name: Generate summary
        run: |
          echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rust Audit | ${{ needs.rust-audit.result == 'success' && 'Passed' || 'Issues Found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Audit | ${{ needs.python-audit.result == 'success' && 'Passed' || 'Issues Found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| npm Audit | ${{ needs.npm-audit.result == 'success' && 'Passed' || 'Issues Found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scan | ${{ needs.secret-scan.result == 'success' && 'Passed' || 'Secrets Found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Scan | ${{ needs.container-scan.result == 'success' && 'Passed' || 'Vulnerabilities Found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL (Rust) | ${{ needs.codeql-rust.result == 'success' && 'Passed' || 'Issues Found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL (Python) | ${{ needs.codeql-python.result == 'success' && 'Passed' || 'Issues Found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL (JS/TS) | ${{ needs.codeql-javascript.result == 'success' && 'Passed' || 'Issues Found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure Scan | ${{ needs.infra-scan.result == 'success' && 'Passed' || 'Issues Found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM Generation | ${{ needs.sbom.result == 'success' && 'Generated' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Detailed reports are available in the Security tab and workflow artifacts." >> $GITHUB_STEP_SUMMARY

      - name: Check for critical failures
        run: |
          # Fail the workflow if secret scanning found issues
          if [[ "${{ needs.secret-scan.result }}" == "failure" ]]; then
            echo "::error::Secret scanning found exposed credentials!"
            exit 1
          fi
