# ══════════════════════════════════════════════════════════════════════════════
# Project Apex - Release Pipeline
# ══════════════════════════════════════════════════════════════════════════════
# Triggered on version tags (v*) or manual dispatch
# Creates GitHub releases, builds and pushes Docker images, generates changelog

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.2.3)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Dry run (do not push images or create release)'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/apex
  CARGO_TERM_COLOR: always

jobs:
  # ════════════════════════════════════════════════════════════════════════════
  # Prepare Release
  # ════════════════════════════════════════════════════════════════════════════
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_short: ${{ steps.version.outputs.version_short }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
            IS_PRERELEASE="${{ inputs.prerelease }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
            # Check if version contains alpha, beta, rc, etc.
            if [[ "$VERSION" =~ (alpha|beta|rc|pre) ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi

          VERSION_SHORT=$(echo "$VERSION" | cut -d'-' -f1)

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_short=$VERSION_SHORT" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

          echo "Version: $VERSION"
          echo "Version Short: $VERSION_SHORT"
          echo "Is Prerelease: $IS_PRERELEASE"

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [[ -z "$PREV_TAG" ]]; then
            # First release - get all commits
            COMMITS=$(git log --oneline --pretty=format:"- %s (%h)" | head -50)
          else
            # Get commits since last tag
            COMMITS=$(git log --oneline --pretty=format:"- %s (%h)" ${PREV_TAG}..HEAD)
          fi

          # Categorize commits
          FEATURES=$(echo "$COMMITS" | grep -iE "^- (feat|add|new)" || true)
          FIXES=$(echo "$COMMITS" | grep -iE "^- (fix|bug|patch)" || true)
          IMPROVEMENTS=$(echo "$COMMITS" | grep -iE "^- (improve|enhance|update|refactor)" || true)
          DOCS=$(echo "$COMMITS" | grep -iE "^- (doc|readme)" || true)
          OTHER=$(echo "$COMMITS" | grep -viE "^- (feat|add|new|fix|bug|patch|improve|enhance|update|refactor|doc|readme)" || true)

          # Build changelog
          CHANGELOG="## What's Changed in v${{ steps.version.outputs.version }}"
          CHANGELOG+="\n\n"

          if [[ -n "$FEATURES" ]]; then
            CHANGELOG+="### Features\n$FEATURES\n\n"
          fi

          if [[ -n "$FIXES" ]]; then
            CHANGELOG+="### Bug Fixes\n$FIXES\n\n"
          fi

          if [[ -n "$IMPROVEMENTS" ]]; then
            CHANGELOG+="### Improvements\n$IMPROVEMENTS\n\n"
          fi

          if [[ -n "$DOCS" ]]; then
            CHANGELOG+="### Documentation\n$DOCS\n\n"
          fi

          if [[ -n "$OTHER" ]]; then
            CHANGELOG+="### Other Changes\n$OTHER\n\n"
          fi

          if [[ -n "$PREV_TAG" ]]; then
            CHANGELOG+="\n**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...v${{ steps.version.outputs.version }}"
          fi

          # Save to file for later use
          echo -e "$CHANGELOG" > changelog.md

          # Set output (escape newlines for GitHub Actions)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat changelog.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload changelog
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: changelog.md

  # ════════════════════════════════════════════════════════════════════════════
  # Build Rust Backend
  # ════════════════════════════════════════════════════════════════════════════
  build-rust:
    name: Build Rust (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            artifact: apex-server
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            artifact: apex-server
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            artifact: apex-server
          - target: x86_64-apple-darwin
            os: macos-latest
            artifact: apex-server
          - target: aarch64-apple-darwin
            os: macos-latest
            artifact: apex-server
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux ARM)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Install musl tools
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Install protobuf compiler (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Install protobuf compiler (macOS)
        if: runner.os == 'macOS'
        run: brew install protobuf

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src/backend/core -> target
          key: release-${{ matrix.target }}

      - name: Build release binary
        working-directory: src/backend/core
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
        run: cargo build --release --target ${{ matrix.target }}

      - name: Package binary
        run: |
          cd src/backend/core/target/${{ matrix.target }}/release
          tar -czvf apex-server-${{ needs.prepare.outputs.version }}-${{ matrix.target }}.tar.gz ${{ matrix.artifact }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: apex-server-${{ matrix.target }}
          path: src/backend/core/target/${{ matrix.target }}/release/apex-server-${{ needs.prepare.outputs.version }}-${{ matrix.target }}.tar.gz

  # ════════════════════════════════════════════════════════════════════════════
  # Build Docker Images
  # ════════════════════════════════════════════════════════════════════════════
  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [prepare, build-rust]
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - image: api
            context: .
            dockerfile: infra/docker/Dockerfile.api
          - image: worker
            context: src/backend/agents
            dockerfile: src/backend/agents/Dockerfile
          - image: dashboard
            context: src/frontend
            dockerfile: src/frontend/Dockerfile
          - image: sandbox
            context: .
            dockerfile: infra/docker/Dockerfile.sandbox
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: ${{ !inputs.dry_run }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        if: ${{ !inputs.dry_run && secrets.DOCKERHUB_TOKEN != '' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.image }}
            ${{ secrets.DOCKERHUB_USERNAME && format('{0}/apex-{1}', secrets.DOCKERHUB_USERNAME, matrix.image) || '' }}
          tags: |
            type=raw,value=${{ needs.prepare.outputs.version }}
            type=raw,value=${{ needs.prepare.outputs.version_short }}
            type=raw,value=latest,enable=${{ needs.prepare.outputs.is_prerelease == 'false' }}
            type=sha,prefix=

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: ${{ !inputs.dry_run }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.prepare.outputs.version }}
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}

      - name: Generate SBOM
        if: ${{ !inputs.dry_run }}
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.image }}:${{ needs.prepare.outputs.version }}
          artifact-name: sbom-${{ matrix.image }}.spdx.json
          output-file: sbom-${{ matrix.image }}.spdx.json

      - name: Upload SBOM
        if: ${{ !inputs.dry_run }}
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ matrix.image }}
          path: sbom-${{ matrix.image }}.spdx.json

  # ════════════════════════════════════════════════════════════════════════════
  # Build Python Package
  # ════════════════════════════════════════════════════════════════════════════
  build-python:
    name: Build Python Package
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: pip install build twine

      - name: Update version
        working-directory: src/backend/agents
        run: |
          # Update version in pyproject.toml
          sed -i "s/^version = .*/version = \"${{ needs.prepare.outputs.version }}\"/" pyproject.toml

      - name: Build package
        working-directory: src/backend/agents
        run: python -m build

      - name: Check package
        working-directory: src/backend/agents
        run: twine check dist/*

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-package
          path: src/backend/agents/dist/

  # ════════════════════════════════════════════════════════════════════════════
  # Build TypeScript SDK
  # ════════════════════════════════════════════════════════════════════════════
  build-typescript:
    name: Build TypeScript SDK
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        working-directory: sdk/typescript
        run: npm ci

      - name: Update version
        working-directory: sdk/typescript
        run: npm version ${{ needs.prepare.outputs.version }} --no-git-tag-version

      - name: Build
        working-directory: sdk/typescript
        run: npm run build

      - name: Pack
        working-directory: sdk/typescript
        run: npm pack

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: npm-package
          path: sdk/typescript/*.tgz

  # ════════════════════════════════════════════════════════════════════════════
  # Build Helm Chart
  # ════════════════════════════════════════════════════════════════════════════
  build-helm:
    name: Build Helm Chart
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Update Chart version
        run: |
          cd infra/k8s/helm/apex
          sed -i "s/^version:.*/version: ${{ needs.prepare.outputs.version }}/" Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${{ needs.prepare.outputs.version }}\"/" Chart.yaml

      - name: Lint Helm chart
        run: helm lint infra/k8s/helm/apex

      - name: Package Helm chart
        run: |
          helm package infra/k8s/helm/apex
          mv apex-${{ needs.prepare.outputs.version }}.tgz apex-chart-${{ needs.prepare.outputs.version }}.tgz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart
          path: apex-chart-${{ needs.prepare.outputs.version }}.tgz

  # ════════════════════════════════════════════════════════════════════════════
  # Create GitHub Release
  # ════════════════════════════════════════════════════════════════════════════
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs:
      - prepare
      - build-rust
      - build-docker
      - build-python
      - build-typescript
      - build-helm
    if: ${{ !inputs.dry_run }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          # Move Rust binaries
          find artifacts -name "*.tar.gz" -exec mv {} release-assets/ \;

          # Move Python package
          find artifacts/python-package -name "*.whl" -exec mv {} release-assets/ \;
          find artifacts/python-package -name "*.tar.gz" -exec mv {} release-assets/ \;

          # Move npm package
          find artifacts/npm-package -name "*.tgz" -exec mv {} release-assets/ \;

          # Move Helm chart
          find artifacts/helm-chart -name "*.tgz" -exec mv {} release-assets/ \;

          # Generate checksums
          cd release-assets
          sha256sum * > SHA256SUMS.txt

          ls -la

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: Apex v${{ needs.prepare.outputs.version }}
          body: ${{ needs.prepare.outputs.changelog }}
          draft: false
          prerelease: ${{ needs.prepare.outputs.is_prerelease == 'true' }}
          files: release-assets/*
          generate_release_notes: false

  # ════════════════════════════════════════════════════════════════════════════
  # Publish Packages
  # ════════════════════════════════════════════════════════════════════════════
  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [prepare, create-release]
    if: ${{ !inputs.dry_run && needs.prepare.outputs.is_prerelease == 'false' }}
    environment: pypi
    steps:
      - name: Download Python package
        uses: actions/download-artifact@v4
        with:
          name: python-package
          path: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true

  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: [prepare, create-release]
    if: ${{ !inputs.dry_run && needs.prepare.outputs.is_prerelease == 'false' }}
    environment: npm
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Download npm package
        uses: actions/download-artifact@v4
        with:
          name: npm-package
          path: ./

      - name: Publish to npm
        run: npm publish *.tgz --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ════════════════════════════════════════════════════════════════════════════
  # Update Helm Repository
  # ════════════════════════════════════════════════════════════════════════════
  publish-helm:
    name: Publish Helm Chart
    runs-on: ubuntu-latest
    needs: [prepare, create-release]
    if: ${{ !inputs.dry_run }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Download Helm chart
        uses: actions/download-artifact@v4
        with:
          name: helm-chart
          path: ./charts

      - name: Update Helm repo index
        run: |
          helm repo index charts --url https://${{ github.repository_owner }}.github.io/apex/charts
          mv charts/index.yaml ./index.yaml || true

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Add Helm chart v${{ needs.prepare.outputs.version }}" || exit 0
          git push

  # ════════════════════════════════════════════════════════════════════════════
  # Notify
  # ════════════════════════════════════════════════════════════════════════════
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs:
      - prepare
      - create-release
      - publish-pypi
      - publish-npm
      - publish-helm
    if: always() && !inputs.dry_run
    steps:
      - name: Send Slack notification
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "Apex v${{ needs.prepare.outputs.version }} has been released! :rocket:",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Apex v${{ needs.prepare.outputs.version }} Released :rocket:"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n${{ needs.create-release.result == 'success' && 'Success' || 'Failed' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Pre-release:*\n${{ needs.prepare.outputs.is_prerelease }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<https://github.com/${{ github.repository }}/releases/tag/v${{ needs.prepare.outputs.version }}|View Release>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
