# ══════════════════════════════════════════════════════════════════════════════
# Project Apex - Docker Compose Development Overrides
# ══════════════════════════════════════════════════════════════════════════════
#
# This file automatically extends docker-compose.yml for local development.
# Docker Compose automatically loads this file when running:
#   docker-compose up
#
# Features:
#   - Volume mounts for hot-reload
#   - Debug ports exposed
#   - Relaxed resource limits
#   - Development environment variables
#   - Additional development tools
#
# ══════════════════════════════════════════════════════════════════════════════

services:
  # ============================================================================
  # APEX CORE SERVICES (Development Overrides)
  # ============================================================================

  apex-api:
    build:
      context: ./src/backend/core
      dockerfile: Dockerfile
      target: development              # Use development stage if multi-stage
      args:
        - RUST_BUILD_MODE=debug
    environment:
      - RUST_LOG=debug,apex_core=trace
      - RUST_BACKTRACE=1
      - APEX_ENV=development
      - APEX_CONFIG=/app/config/development.toml
      - DATABASE_URL=postgres://apex:apex_secret@postgres:5432/apex
      - REDIS_URL=redis://redis:6379
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - APEX_DEBUG_ENABLED=true
    volumes:
      # Source code for hot-reload (if using cargo-watch)
      - ./src/backend/core:/app/src:cached
      - ./config:/app/config:ro
      - ./migrations:/app/migrations:ro
      # Cargo cache for faster rebuilds
      - cargo-cache:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - target-cache:/app/target
    ports:
      - "8080:8080"                    # REST API
      - "50051:50051"                  # gRPC
      - "9090:9090"                    # Prometheus metrics
      - "5555:5555"                    # Debug port (if applicable)
    deploy:
      resources:
        limits:
          cpus: '4'                    # More CPU for development
          memory: 4G                   # More memory for debug builds
    # Enable hot-reload with cargo-watch
    command: >
      cargo watch -x 'run --features development'
    stdin_open: true
    tty: true

  apex-worker:
    build:
      context: ./src/backend/agents
      dockerfile: Dockerfile
      target: development
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - APEX_ENV=development
      - APEX_CONFIG=/app/config/development.toml
      - DATABASE_URL=postgres://apex:apex_secret@postgres:5432/apex
      - REDIS_URL=redis://redis:6379
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # Debug settings
      - PYTHONDEVMODE=1
      - LOG_LEVEL=DEBUG
    volumes:
      # Source code for hot-reload
      - ./src/backend/agents:/app:cached
      - ./config:/app/config:ro
      # Python cache
      - pip-cache:/root/.cache/pip
    ports:
      - "5678:5678"                    # Python debugger (debugpy)
    deploy:
      replicas: 1                      # Single worker for development
      resources:
        limits:
          cpus: '2'
          memory: 2G
    # Enable hot-reload with watchmedo
    command: >
      watchmedo auto-restart --directory=. --pattern=*.py --recursive --
      python -m debugpy --listen 0.0.0.0:5678 -m apex_worker

  apex-dashboard:
    build:
      context: ./src/frontend
      dockerfile: Dockerfile
      target: development
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://localhost:8080
      - VITE_WS_URL=ws://localhost:8080/ws
      - VITE_GRPC_URL=http://localhost:50051
    volumes:
      # Source code for hot-reload
      - ./src/frontend:/app:cached
      # Don't mount node_modules from host
      - /app/node_modules
    ports:
      - "3000:5173"                    # Vite dev server port
      - "24678:24678"                  # Vite HMR websocket
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
    command: npm run dev -- --host 0.0.0.0

  # ============================================================================
  # DATA STORES (Development Overrides)
  # ============================================================================

  postgres:
    environment:
      - POSTGRES_USER=apex
      - POSTGRES_PASSWORD=apex_secret
      - POSTGRES_DB=apex
    ports:
      - "5432:5432"                    # Expose to host for local tools
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./src/backend/core/migrations:/docker-entrypoint-initdb.d:ro
      # Custom PostgreSQL config for development
      - ./infra/docker/postgres-dev.conf:/etc/postgresql/postgresql.conf:ro
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G

  redis:
    ports:
      - "6379:6379"                    # Expose to host
    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --loglevel verbose
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # ============================================================================
  # OBSERVABILITY STACK (Development Overrides)
  # ============================================================================

  jaeger:
    ports:
      - "16686:16686"                  # Jaeger UI
      - "4317:4317"                    # OTLP gRPC
      - "4318:4318"                    # OTLP HTTP
      - "6831:6831/udp"                # Jaeger thrift compact
      - "14268:14268"                  # Jaeger HTTP collector
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - LOG_LEVEL=debug

  prometheus:
    ports:
      - "9091:9090"                    # Different port to avoid conflict
    volumes:
      - ./infra/observability/prometheus/prometheus-dev.yml:/etc/prometheus/prometheus.yml:ro
      - ./infra/observability/prometheus/rules:/etc/prometheus/rules:ro
      - ./infra/monitoring/alerts:/etc/prometheus/alerts:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=7d'  # Shorter retention for dev
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'            # Enable admin API for dev

  grafana:
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=apex_admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_AUTH_ANONYMOUS_ENABLED=true       # Enable anonymous access for dev
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
      - GF_LOG_LEVEL=debug
    ports:
      - "3001:3000"
    volumes:
      - ./infra/observability/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./infra/observability/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - ./infra/monitoring/dashboards:/var/lib/grafana/dashboards/monitoring:ro
      - grafana-data:/var/lib/grafana

  loki:
    ports:
      - "3100:3100"
    volumes:
      - ./infra/observability/loki/loki-dev.yml:/etc/loki/local-config.yaml:ro
      - loki-data:/loki

  # ============================================================================
  # DEVELOPMENT TOOLS (Additional Services)
  # ============================================================================

  # pgAdmin for database management
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: apex-pgadmin
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@apex.local
      - PGADMIN_DEFAULT_PASSWORD=apex_admin
      - PGADMIN_LISTEN_PORT=80
    ports:
      - "5050:80"
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - apex-internal
    profiles:
      - tools                          # Only start with: docker-compose --profile tools up

  # Redis Commander for cache inspection
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: apex-redis-commander
    environment:
      - REDIS_HOSTS=local:redis:6379
    ports:
      - "8081:8081"
    depends_on:
      - redis
    networks:
      - apex-internal
    profiles:
      - tools

  # MailHog for email testing
  mailhog:
    image: mailhog/mailhog:latest
    container_name: apex-mailhog
    ports:
      - "1025:1025"                    # SMTP
      - "8025:8025"                    # Web UI
    networks:
      - apex-internal
    profiles:
      - tools

  # Swagger UI for API documentation
  swagger-ui:
    image: swaggerapi/swagger-ui:latest
    container_name: apex-swagger
    environment:
      - SWAGGER_JSON=/spec/openapi.yaml
      - BASE_URL=/docs
    ports:
      - "8082:8080"
    volumes:
      - ./docs/api:/spec:ro
    networks:
      - apex-internal
    profiles:
      - tools

  # Locust for load testing
  locust:
    image: locustio/locust:latest
    container_name: apex-locust
    ports:
      - "8089:8089"
    volumes:
      - ./tests/load:/mnt/locust:ro
    command: -f /mnt/locust/locustfile.py --host=http://apex-api:8080
    depends_on:
      - apex-api
    networks:
      - apex-internal
    profiles:
      - testing

# ============================================================================
# ADDITIONAL VOLUMES
# ============================================================================

volumes:
  # Existing volumes from docker-compose.yml are extended
  postgres-data:
  redis-data:
  prometheus-data:
  grafana-data:
  loki-data:

  # New development-specific volumes
  cargo-cache:
    driver: local
  cargo-git:
    driver: local
  target-cache:
    driver: local
  pip-cache:
    driver: local
  pgadmin-data:
    driver: local

# ============================================================================
# NETWORK CONFIGURATION
# ============================================================================

networks:
  apex-internal:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
